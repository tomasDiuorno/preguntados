<main class="w-full p-8 flex flex-col gap-8 text-[#E2E4F3]">

  <h1 class="text-3xl font-bold border-b-2 border-[#2c2f56] pb-3">Panel del Editor</h1>

  <!-- ===== BOTÓN DESPLEGAR FORMULARIO ===== -->
  <button 
    onclick="toggleFormulario()" 
    class="w-fit py-3 px-6 rounded-lg bg-gradient-to-r from-[#E65895] to-[#BC6BE8] font-semibold text-white hover:opacity-90 active:opacity-80 transition flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
      <path fill-rule="evenodd" d="M12 2.25a9.75 9.75 0 1 0 9.75 9.75A9.76 9.76 0 0 0 12 2.25Zm0 18a8.25 8.25 0 1 1 8.25-8.25A8.26 8.26 0 0 1 12 20.25ZM12.75 7.5a.75.75 0 0 0-1.5 0v4.5H7.5a.75.75 0 0 0 0 1.5h3.75v3.75a.75.75 0 0 0 1.5 0V13.5H16.5a.75.75 0 0 0 0-1.5h-3.75Z" clip-rule="evenodd"/>
    </svg>
    Agregar Nueva Pregunta
  </button>

  <!-- ===== FORMULARIO NUEVA PREGUNTA ===== -->
  <section id="formulario" class="bg-[#2c2f56] rounded-xl p-6 shadow-xl hidden transition-all duration-300">
    <h2 class="text-2xl font-semibold mb-4 text-[#BC6BE8] flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6">
        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75S6.615 21.75 12 21.75 21.75 17.385 21.75 12 17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clip-rule="evenodd" />
      </svg>
      Nueva Pregunta
    </h2>

  <form action="/index.php?controller=paneleditor&method=guardar" method="POST" class="flex flex-col gap-4">
      <div>
        <label class="block text-sm mb-1 text-gray-300">Descripción</label>
        <textarea name="descripcion" rows="3" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-[#BC6BE8]"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1 text-gray-300">Categoría</label>
          <select name="id_categoria" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
            <option value="">Seleccionar...</option>
            <option value="1">Geografía</option>
            <option value="2">Historia</option>
            <option value="3">Ciencia</option>
            <option value="4">Deportes</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1 text-gray-300">Dificultad</label>
          <select name="id_dificultad" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
            <option value="">Seleccionar...</option>
            <option value="1">Fácil</option>
            <option value="2">Media</option>
            <option value="3">Difícil</option>
          </select>
        </div>
      </div>

      <!-- ===== RESPUESTAS ===== -->
      <div class="mt-2">
        <h3 class="text-lg font-semibold text-[#BC6BE8] mb-2">Respuestas</h3>
        <div class="flex flex-col gap-2">
          <div>
            <label class="block text-sm mb-1 text-green-400">Respuesta correcta:</label>
            <input type="text" name="respuesta_correcta" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
          <div>
            <label class="block text-sm mb-1 text-red-400">Respuesta incorrecta 1:</label>
            <input type="text" name="respuesta_incorrecta1" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
          <div>
            <label class="block text-sm mb-1 text-red-400">Respuesta incorrecta 2:</label>
            <input type="text" name="respuesta_incorrecta2" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
          <div>
            <label class="block text-sm mb-1 text-red-400">Respuesta incorrecta 3:</label>
            <input type="text" name="respuesta_incorrecta3" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
        </div>
      </div>

      <button type="submit" class="mt-4 py-3 px-6 rounded-lg bg-gradient-to-r from-[#E65895] to-[#BC6BE8] font-semibold text-white hover:opacity-90 active:opacity-80 transition">
        Guardar Pregunta
      </button>
    </form>
  
  </section>

  <!-- ===== LISTADO DE PREGUNTAS EXISTENTES ===== -->
  <section>
    <h2 class="text-2xl font-semibold mb-4 text-[#BC6BE8] flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6">
        <path fill-rule="evenodd" d="M4.5 2.25a.75.75 0 0 0 0 1.5v16.5a.75.75 0 0 0 0 1.5h15a.75.75 0 0 0 0-1.5V3.75a.75.75 0 0 0 0-1.5h-15ZM6 6.75h12v1.5H6v-1.5Zm0 4.5h12v1.5H6v-1.5Zm0 4.5h12v1.5H6v-1.5Z" clip-rule="evenodd" />
      </svg>
      Listado de Preguntas
    </h2>

    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-[#2c2f56] text-[#E2E4F3]">
            <th class="p-3 text-left">ID</th>
            <th class="p-3 text-left">Descripción</th>
            <th class="p-3 text-left">Categoría</th>
            <th class="p-3 text-left">Dificultad</th>
            <th class="p-3 text-center">Aprobada</th>
            <th class="p-3 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody class="text-gray-300">
  {{#preguntas}}
  <tr class="border-b border-[#3f4477] hover:bg-[#3f4477] transition">
    <td class="p-3">{{id}}</td>
    <td class="p-3">{{descripcion}}</td>
    <td class="p-3">{{categoria}}</td>
    <td class="p-3">{{dificultad}}</td>
    <td class="p-3 text-center">
      {{#aprobada}}
        <span class="text-green-400 font-semibold">Sí</span>
      {{/aprobada}}
      {{^aprobada}}
        <span class="text-red-400 font-semibold">No</span>
      {{/aprobada}}
    </td>
            <td class="p-3 flex justify-center gap-2">
<a href="/index.php?controller=editorpregunta&method=editar&id={{id}}" class="px-3 py-1 bg-[#BC6BE8] rounded-lg hover:opacity-80 transition text-white">Editar</a>             
<button onclick="abrirModalEliminarInline({{id}})" data-action="eliminar" data-id="{{id}}" class="px-3 py-1 bg-red-600 rounded-lg hover:bg-red-700 transition text-white">Eliminar</button>
            </td>
  </tr>
  {{/preguntas}}
</tbody>
      </table>
    </div>
  </section>

</main>

<script>
  // Función para mostrar/ocultar el formulario de nueva pregunta
  function toggleFormulario() {
    const form = document.getElementById("formulario");
    form.classList.toggle("hidden");
  }
</script>

<!-- Modal de edición de pregunta -->
<div id="modalEditar" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-[#1e1f3b] rounded-lg p-6 w-full max-w-2xl text-white shadow-lg">
    <h3 class="text-xl font-semibold mb-3">Editar Pregunta</h3>
    <form id="formEditar" class="flex flex-col gap-4">
      <input type="hidden" id="pregunta_id" name="id">
      
      <div>
        <label class="block text-sm mb-1 text-gray-300">Descripción</label>
        <textarea id="edit_descripcion" name="descripcion" rows="3" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white focus:outline-none focus:ring-2 focus:ring-[#BC6BE8]"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1 text-gray-300">Categoría</label>
          <select id="edit_id_categoria" name="id_categoria" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
            <option value="1">Geografía</option>
            <option value="2">Historia</option>
            <option value="3">Ciencia</option>
            <option value="4">Deportes</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1 text-gray-300">Dificultad</label>
          <select id="edit_id_dificultad" name="id_dificultad" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
            <option value="1">Fácil</option>
            <option value="2">Media</option>
            <option value="3">Difícil</option>
          </select>
        </div>
      </div>

      <div class="mt-2">
        <h4 class="text-lg font-semibold text-[#BC6BE8] mb-2">Respuestas</h4>
        <div class="flex flex-col gap-2">
          <div>
            <label class="block text-sm mb-1 text-green-400">Respuesta correcta:</label>
            <input type="text" id="edit_respuesta_correcta" name="respuesta_correcta" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
          <div>
            <label class="block text-sm mb-1 text-red-400">Respuesta incorrecta 1:</label>
            <input type="text" id="edit_respuesta_incorrecta1" name="respuesta_incorrecta1" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
          <div>
            <label class="block text-sm mb-1 text-red-400">Respuesta incorrecta 2:</label>
            <input type="text" id="edit_respuesta_incorrecta2" name="respuesta_incorrecta2" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
          <div>
            <label class="block text-sm mb-1 text-red-400">Respuesta incorrecta 3:</label>
            <input type="text" id="edit_respuesta_incorrecta3" name="respuesta_incorrecta3" class="w-full bg-[#1e1f3b] border border-[#3f4477] rounded-lg p-2 text-white">
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="cerrarModalEditar()" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-[#BC6BE8] rounded-lg hover:opacity-80">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de eliminación -->
<div id="modalEliminar" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-[#1e1f3b] rounded-lg p-6 w-full max-w-md text-white shadow-lg">
    <h3 class="text-xl font-semibold mb-3">¿Estás seguro?</h3>
    <p class="text-sm text-gray-300 mb-5">Esta acción eliminará permanentemente la pregunta seleccionada.</p>
    <div class="flex justify-end gap-3">
      <button onclick="cerrarModalEliminar()" class="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-700">Cancelar</button>
      <button onclick="eliminarPregunta()" class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700">Aceptar</button>
    </div>
  </div>
</div>

<script>
  // Variables para los modales
  let preguntaAEliminarId = null;
  const modalEliminar = document.getElementById('modalEliminar');
  const modalEditar = document.getElementById('modalEditar');
  const formEditar = document.getElementById('formEditar');

  // === FUNCIONES PARA ELIMINAR ===
  function abrirModalEliminar(id) {
    preguntaAEliminarId = id;
    modalEliminar.classList.remove('hidden');
    modalEliminar.classList.add('flex');
  }

  function cerrarModalEliminar() {
    modalEliminar.classList.remove('flex');
    modalEliminar.classList.add('hidden');
    preguntaAEliminarId = null;
  }

  function eliminarPregunta() {
    if (preguntaAEliminarId) {
      const form = document.createElement('form');
      form.method = 'POST';
  form.action = '/index.php?controller=paneleditor&method=eliminar';
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'id';
      input.value = preguntaAEliminarId;
      
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
    cerrarModalEliminar();
  }

  // === FUNCIONES PARA EDITAR ===
  async function abrirModalEditar(id) {
    try {
      console.log('abrirModalEditar called, id=', id);
      // Obtener datos de la pregunta
  const response = await fetch(`/index.php?controller=paneleditor&method=obtenerPregunta&id=${id}`);
      const data = await response.json();
      
      // Llenar el formulario con los datos
      document.getElementById('pregunta_id').value = data.pregunta.id;
      document.getElementById('edit_descripcion').value = data.pregunta.descripcion;
      document.getElementById('edit_id_categoria').value = data.pregunta.id_categoria;
      document.getElementById('edit_id_dificultad').value = data.pregunta.id_dificultad;
      
      // Llenar respuestas
      const respuestaCorrecta = data.respuestas.find(r => r.es_correcta === 1);
      const respuestasIncorrectas = data.respuestas.filter(r => r.es_correcta === 0);
      
      document.getElementById('edit_respuesta_correcta').value = respuestaCorrecta.descripcion;
      document.getElementById('edit_respuesta_incorrecta1').value = respuestasIncorrectas[0].descripcion;
      document.getElementById('edit_respuesta_incorrecta2').value = respuestasIncorrectas[1].descripcion;
      document.getElementById('edit_respuesta_incorrecta3').value = respuestasIncorrectas[2].descripcion;
      
      // Mostrar modal
      modalEditar.classList.remove('hidden');
      modalEditar.classList.add('flex');
    } catch (error) {
      console.error('Error al cargar la pregunta:', error);
    }
  }

  function cerrarModalEditar() {
    modalEditar.classList.remove('flex');
    modalEditar.classList.add('hidden');
    formEditar.reset();
  }

  // Manejar el envío del formulario de edición
  formEditar.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      const formData = new FormData(formEditar);
  const response = await fetch('/index.php?controller=paneleditor&method=actualizar', {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        window.location.reload(); // Recargar para ver los cambios
      } else {
        console.error('Error al actualizar la pregunta');
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });
</script>

<script>
  // Delegación de eventos para botones Editar / Eliminar (funciona aunque haya inline handlers rotos)
  document.addEventListener('click', function (e) {

    const eliminarBtn = e.target.closest('button[data-action="eliminar"]');
    if (eliminarBtn) {
      e.preventDefault();
      const id = eliminarBtn.dataset.id;
      try {
        abrirModalEliminar(id);
      } catch (err) {
        console.error('abrirModalEliminar no definida o falló:', err);
      }
      return;
    }
  });
</script>

<script>
  // Wrappers inline seguros para forzar ejecución y mostrar errores si fallan

  function abrirModalEliminarInline(id) {
    console.log('abrirModalEliminarInline called, id=', id);
    try {
      if (typeof abrirModalEliminar === 'function') {
        abrirModalEliminar(id);
      } else {
        console.error('abrirModalEliminar no está definida');
        alert('Error: función abrirModalEliminar no definida (ver consola).');
      }
    } catch (err) {
      console.error('Error en abrirModalEliminarInline:', err);
      alert('Error al abrir el modal de eliminación. Revisa la consola para más detalles.');
    }
  }

  // Registrar errores globales para ayudar a depurar problemas JS que bloqueen la página
  window.addEventListener('error', function (event) {
    console.error('Uncaught error:', event.error || event.message, event);
  });
  window.addEventListener('unhandledrejection', function (event) {
    console.error('Unhandled rejection:', event.reason);
  });
</script>

<!-- DEBUG: registrar clicks y estado de funciones para ayudar a depurar -->
<script>
  document.addEventListener('click', function (e) {
    try {
      const btn = e.target.closest('button');
      if (!btn) return;
      console.log('[DEBUG] botón clickeado:', btn.textContent.trim(), 'data-action=', btn.dataset.action, 'data-id=', btn.dataset.id);
      // comprobar si las funciones están definidas
      console.log('[DEBUG] abrirModalEditar definida?', typeof abrirModalEditar === 'function');
      console.log('[DEBUG] abrirModalEliminar definida?', typeof abrirModalEliminar === 'function');
    } catch (err) {
      console.error('[DEBUG] error en listener debug:', err);
    }
  }, { capture: true });
</script>


