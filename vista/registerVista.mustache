<body class="bg-[#1e1f3b] bg-[url('/imagenes/bg.jpg')] bg-cover bg-center flex justify-center items-center min-h-screen py-12 px-4">

<main class="bg-[#343964] rounded-2xl shadow-2xl w-full max-w-xl p-8 flex flex-col gap-4 text-[#E2E4F3]">
    <h1 class="text-3xl font-bold text-center">Crear cuenta</h1>

    {{#error}}
        <div class="bg-red-900/50 border border-red-700 text-red-300 p-3 rounded-lg flex items-center gap-3 text-sm">
            <svg class="h-5 w-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
            <span>{{error}}</span>
        </div>
    {{/error}}

    <form class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mt-4" method="POST" action="/register/base" enctype="multipart/form-data">

        <div class="col-span-1 md:col-span-2 flex flex-col items-center">
            <label for="profilePic" class="cursor-pointer">
                <img id="previewImage" src="/imagenes/placeholder.png"
                     alt="Previsualización"
                     class="w-[100px] h-[100px] rounded-full object-cover border-2 border-[#E65895] mb-3">
            </label>
            <input type="file" name="profilePic" id="profilePic" accept="image/*" class="hidden">
            <p class="text-sm opacity-70">Haz clic en la imagen para subir una foto</p>
        </div>

        <div>
            <label class="block text-sm font-semibold mb-2">Nombre completo</label>
            <input type="text" name="name" class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition" placeholder="Ej: Juan Pérez" required>
        </div>

        <div>
            <label class="block text-sm font-semibold mb-2">Nombre de usuario</label>
            <input name="username" type="text" class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition" placeholder="Tu usuario" required>
        </div>


        <div>
            <label class="block text-sm font-semibold mb-2">Sexo</label>
            <select name="gender"
                    class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition appearance-none bg-no-repeat bg-[right_0.75rem_center]"
                    style="background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 20 20%22 fill=%22none%22 stroke=%22%23BC6BE8%22 stroke-width=%221.5%22><path d=%22M6 8l4 4 4-4%22/></svg>'); background-size: 1.25em 1.25em;"
                    required>
                <option>Masculino</option>
                <option>Femenino</option>
                <option>Prefiero no cargarlo</option>
            </select>
        </div>


        <div>
            <label class="block text-sm font-semibold mb-2">Año de nacimiento</label>
            <input type="number" name="birthdate" class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" placeholder="Ej: 1998" required>
        </div>

        <div class="col-span-1 md:col-span-2">
            <label  class="block text-sm font-semibold mb-2">País y ciudad</label>
            <input id="addressInput" type="text" name="address" class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition" placeholder="Ej: Argentina, Buenos Aires" required>
            <div id="map" class="w-full h-[250px] rounded-lg border border-gray-600"></div>
            <p class="text-xs opacity-70 mt-1">Haz clic en el mapa para seleccionar tu ubicación</p>
        </div>

        <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-semibold mb-2">Correo electrónico</label>
            <input name="email" type="email" class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition" placeholder="usuario@ejemplo.com" required>
        </div>

        <div>
            <label class="block text-sm font-semibold mb-2">Contraseña</label>
            <input name="password" type="password" class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition" placeholder="********" required>
        </div>

        <div>
            <label class="block text-sm font-semibold mb-2">Repetir contraseña</label>
            <input name="passwordRepeated" type="password" class="w-full p-3 rounded-lg bg-[#2c2f56] border border-gray-500 text-[#E2E4F3] focus:border-[#E65895] focus:ring-2 focus:ring-[#E65895] focus:outline-none transition" placeholder="********" required>
        </div>

        <button type="submit" class="col-span-1 md:col-span-2 w-full mt-3 py-3 rounded-lg bg-gradient-to-r from-[#E65895] to-[#BC6BE8] text-white font-semibold hover:opacity-90 active:opacity-80 transition focus:outline-none focus:ring-2 focus:ring-[#BC6BE8] focus:ring-offset-2 focus:ring-offset-[#343964]">
            Registrarse
        </button>
    </form>

    <p class="text-center text-sm text-gray-400 mt-4">Al registrarte, recibirás un correo con un enlace para validar tu cuenta.</p>
    <p class="text-center text-sm text-gray-400 mt-2">
        ¿Ya tenés cuenta?
        <a href="/login" class="font-semibold text-[#BC6BE8] hover:text-[#E65895] transition">
            Iniciá sesión
        </a>
    </p>
</main>

<script>
    const inputFile = document.getElementById('profilePic');
    const previewImg = document.getElementById('previewImage');

    inputFile.addEventListener('change', () => {
        const file = inputFile.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => previewImg.src = e.target.result;
            reader.readAsDataURL(file);
        }
    });

    // Inicializar mapa
        const map = L.map('map').setView([-34.6037, -58.3816], 4); // Argentina por defecto
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let marker;

        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;

            if (marker) marker.remove();
            marker = L.marker([lat, lng]).addTo(map);

            try {
                const response = await fetch(`/helper/nominatim.php?lat=${lat}&lon=${lng}`);

                if (!response.ok) {
                    const text = await response.text();
                    console.error('Error HTTP:', text);
                    return;
                }

                const data = await response.json();

                const address = data.address || {};
                const city = address.city || address.town || address.village || address.state || '';
                const country = address.country || '';
                const fullAddress = country && city ? `${country}, ${city}` : (country || city || 'Ubicación desconocida');

                document.getElementById('addressInput').value = fullAddress;
            } catch (error) {
                console.error('Error al obtener ubicación:', error);
            }

        });
</script>

</body>